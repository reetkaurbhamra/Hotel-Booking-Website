const timespan=require("./lib/timespan"),PS_SUPPORTED=require("./lib/psSupported"),validateAsymmetricKey=require("./lib/validateAsymmetricKey"),jws=require("jws"),{includes,isBoolean,isInteger,isNumber,isPlainObject,isString,once}=require("lodash"),{KeyObject,createSecretKey,createPrivateKey}=require("crypto"),SUPPORTED_ALGS=["RS256","RS384","RS512","ES256","ES384","ES512","HS256","HS384","HS512","none"],sign_options_schema=(PS_SUPPORTED&&SUPPORTED_ALGS.splice(3,0,"PS256","PS384","PS512"),{expiresIn:{isValid:function(e){return isInteger(e)||isString(e)&&e},message:'"expiresIn" should be a number of seconds or string representing a timespan'},notBefore:{isValid:function(e){return isInteger(e)||isString(e)&&e},message:'"notBefore" should be a number of seconds or string representing a timespan'},audience:{isValid:function(e){return isString(e)||Array.isArray(e)},message:'"audience" must be a string or array'},algorithm:{isValid:includes.bind(null,SUPPORTED_ALGS),message:'"algorithm" must be a valid string enum value'},header:{isValid:isPlainObject,message:'"header" must be an object'},encoding:{isValid:isString,message:'"encoding" must be a string'},issuer:{isValid:isString,message:'"issuer" must be a string'},subject:{isValid:isString,message:'"subject" must be a string'},jwtid:{isValid:isString,message:'"jwtid" must be a string'},noTimestamp:{isValid:isBoolean,message:'"noTimestamp" must be a boolean'},keyid:{isValid:isString,message:'"keyid" must be a string'},mutatePayload:{isValid:isBoolean,message:'"mutatePayload" must be a boolean'},allowInsecureKeySizes:{isValid:isBoolean,message:'"allowInsecureKeySizes" must be a boolean'},allowInvalidAsymmetricKeyTypes:{isValid:isBoolean,message:'"allowInvalidAsymmetricKeyTypes" must be a boolean'}}),registered_claims_schema={iat:{isValid:isNumber,message:'"iat" should be a number of seconds'},exp:{isValid:isNumber,message:'"exp" should be a number of seconds'},nbf:{isValid:isNumber,message:'"nbf" should be a number of seconds'}};function validate(r,t,s,a){if(!isPlainObject(s))throw new Error('Expected "'+a+'" to be a plain object.');Object.keys(s).forEach(function(e){const i=r[e];if(!i){if(t)return;throw new Error('"'+e+'" is not allowed in "'+a+'"')}if(!i.isValid(s[e]))throw new Error(i.message)})}function validateOptions(e){return validate(sign_options_schema,!1,e,"options")}function validatePayload(e){return validate(registered_claims_schema,!0,e,"payload")}const options_to_payload={audience:"aud",issuer:"iss",subject:"sub",jwtid:"jti"},options_for_objects=["expiresIn","notBefore","noTimestamp","audience","issuer","subject","jwtid"];module.exports=function(r,i,t,s){t="function"==typeof t?(s=t,{}):t||{};var e="object"==typeof r&&!Buffer.isBuffer(r);const a=Object.assign({alg:t.algorithm||"HS256",typ:e?"JWT":void 0,kid:t.keyid},t.header);function n(e){if(s)return s(e);throw e}if(!i&&"none"!==t.algorithm)return n(new Error("secretOrPrivateKey must have a value"));if(null!=i&&!(i instanceof KeyObject))try{i=createPrivateKey(i)}catch(e){try{i=createSecretKey("string"==typeof i?Buffer.from(i):i)}catch(e){return n(new Error("secretOrPrivateKey is not valid key material"))}}if(a.alg.startsWith("HS")&&"secret"!==i.type)return n(new Error("secretOrPrivateKey must be a symmetric key when using "+a.alg));if(/^(?:RS|PS|ES)/.test(a.alg)){if("private"!==i.type)return n(new Error("secretOrPrivateKey must be an asymmetric key when using "+a.alg));if(!t.allowInsecureKeySizes&&!a.alg.startsWith("ES")&&void 0!==i.asymmetricKeyDetails&&i.asymmetricKeyDetails.modulusLength<2048)return n(new Error("secretOrPrivateKey has a minimum key size of 2048 bits for "+a.alg))}if(void 0===r)return n(new Error("payload is required"));if(e){try{validatePayload(r)}catch(e){return n(e)}t.mutatePayload||(r=Object.assign({},r))}else{const l=options_for_objects.filter(function(e){return void 0!==t[e]});if(0<l.length)return n(new Error("invalid "+l.join(",")+" option for "+typeof r+" payload"))}if(void 0!==r.exp&&void 0!==t.expiresIn)return n(new Error('Bad "options.expiresIn" option the payload already has an "exp" property.'));if(void 0!==r.nbf&&void 0!==t.notBefore)return n(new Error('Bad "options.notBefore" option the payload already has an "nbf" property.'));try{validateOptions(t)}catch(e){return n(e)}if(!t.allowInvalidAsymmetricKeyTypes)try{validateAsymmetricKey(a.alg,i)}catch(e){return n(e)}var o=r.iat||Math.floor(Date.now()/1e3);if(t.noTimestamp?delete r.iat:e&&(r.iat=o),void 0!==t.notBefore){try{r.nbf=timespan(t.notBefore,o)}catch(e){return n(e)}if(void 0===r.nbf)return n(new Error('"notBefore" should be a number of seconds or string representing a timespan eg: "1d", "20h", 60'))}if(void 0!==t.expiresIn&&"object"==typeof r){try{r.exp=timespan(t.expiresIn,o)}catch(e){return n(e)}if(void 0===r.exp)return n(new Error('"expiresIn" should be a number of seconds or string representing a timespan eg: "1d", "20h", 60'))}Object.keys(options_to_payload).forEach(function(e){var i=options_to_payload[e];if(void 0!==t[e]){if(void 0!==r[i])return n(new Error('Bad "options.'+e+'" option. The payload already has an "'+i+'" property.'));r[i]=t[e]}});e=t.encoding||"utf8";if("function"!=typeof s){o=jws.sign({header:a,payload:r,secret:i,encoding:e});if(!t.allowInsecureKeySizes&&/^(?:RS|PS)/.test(a.alg)&&o.length<256)throw new Error("secretOrPrivateKey has a minimum key size of 2048 bits for "+a.alg);return o}s=s&&once(s),jws.createSign({header:a,privateKey:i,payload:r,encoding:e}).once("error",s).once("done",function(e){if(!t.allowInsecureKeySizes&&/^(?:RS|PS)/.test(a.alg)&&e.length<256)return s(new Error("secretOrPrivateKey has a minimum key size of 2048 bits for "+a.alg));s(null,e)})};