const JsonWebTokenError=require("./lib/JsonWebTokenError"),NotBeforeError=require("./lib/NotBeforeError"),TokenExpiredError=require("./lib/TokenExpiredError"),decode=require("./decode"),timespan=require("./lib/timespan"),validateAsymmetricKey=require("./lib/validateAsymmetricKey"),PS_SUPPORTED=require("./lib/psSupported"),jws=require("jws"),{KeyObject,createSecretKey,createPublicKey}=require("crypto"),PUB_KEY_ALGS=["RS256","RS384","RS512"],EC_KEY_ALGS=["ES256","ES384","ES512"],RSA_KEY_ALGS=["RS256","RS384","RS512"],HS_ALGS=["HS256","HS384","HS512"];PS_SUPPORTED&&(PUB_KEY_ALGS.splice(PUB_KEY_ALGS.length,0,"PS256","PS384","PS512"),RSA_KEY_ALGS.splice(RSA_KEY_ALGS.length,0,"PS256","PS384","PS512")),module.exports=function(i,n,s,e){"function"!=typeof s||e||(e=s,s={}),s=s||{},s=Object.assign({},s);let a;if(a=e||function(e,r){if(e)throw e;return r},s.clockTimestamp&&"number"!=typeof s.clockTimestamp)return a(new JsonWebTokenError("clockTimestamp must be a number"));if(void 0!==s.nonce&&("string"!=typeof s.nonce||""===s.nonce.trim()))return a(new JsonWebTokenError("nonce must be a non-empty string"));if(void 0!==s.allowInvalidAsymmetricKeyTypes&&"boolean"!=typeof s.allowInvalidAsymmetricKeyTypes)return a(new JsonWebTokenError("allowInvalidAsymmetricKeyTypes must be a boolean"));const c=s.clockTimestamp||Math.floor(Date.now()/1e3);if(!i)return a(new JsonWebTokenError("jwt must be provided"));if("string"!=typeof i)return a(new JsonWebTokenError("jwt must be a string"));const u=i.split(".");if(3!==u.length)return a(new JsonWebTokenError("jwt malformed"));let l;try{l=decode(i,{complete:!0})}catch(e){return a(e)}if(!l)return a(new JsonWebTokenError("invalid token"));const f=l.header;let r;if("function"==typeof n){if(!e)return a(new JsonWebTokenError("verify must be called asynchronous if secret or public key is provided as a callback"));r=n}else r=function(e,r){return r(null,n)};return r(f,function(e,r){if(e)return a(new JsonWebTokenError("error in secret or public key callback: "+e.message));e=""!==u[2].trim();if(!e&&r)return a(new JsonWebTokenError("jwt signature is required"));if(e&&!r)return a(new JsonWebTokenError("secret or public key must be provided"));if(!e&&!s.algorithms)return a(new JsonWebTokenError('please specify "none" in "algorithms" to verify unsigned tokens'));if(null!=r&&!(r instanceof KeyObject))try{r=createPublicKey(r)}catch(e){try{r=createSecretKey("string"==typeof r?Buffer.from(r):r)}catch(e){return a(new JsonWebTokenError("secretOrPublicKey is not valid key material"))}}if(s.algorithms||("secret"===r.type?s.algorithms=HS_ALGS:["rsa","rsa-pss"].includes(r.asymmetricKeyType)?s.algorithms=RSA_KEY_ALGS:"ec"===r.asymmetricKeyType?s.algorithms=EC_KEY_ALGS:s.algorithms=PUB_KEY_ALGS),-1===s.algorithms.indexOf(l.header.alg))return a(new JsonWebTokenError("invalid algorithm"));if(f.alg.startsWith("HS")&&"secret"!==r.type)return a(new JsonWebTokenError("secretOrPublicKey must be a symmetric key when using "+f.alg));if(/^(?:RS|PS|ES)/.test(f.alg)&&"public"!==r.type)return a(new JsonWebTokenError("secretOrPublicKey must be an asymmetric key when using "+f.alg));if(!s.allowInvalidAsymmetricKeyTypes)try{validateAsymmetricKey(f.alg,r)}catch(e){return a(e)}let n;try{n=jws.verify(i,l.header.alg,r)}catch(e){return a(e)}if(!n)return a(new JsonWebTokenError("invalid signature"));e=l.payload;if(void 0!==e.nbf&&!s.ignoreNotBefore){if("number"!=typeof e.nbf)return a(new JsonWebTokenError("invalid nbf value"));if(e.nbf>c+(s.clockTolerance||0))return a(new NotBeforeError("jwt not active",new Date(1e3*e.nbf)))}if(void 0!==e.exp&&!s.ignoreExpiration){if("number"!=typeof e.exp)return a(new JsonWebTokenError("invalid exp value"));if(c>=e.exp+(s.clockTolerance||0))return a(new TokenExpiredError("jwt expired",new Date(1e3*e.exp)))}if(s.audience){const t=Array.isArray(s.audience)?s.audience:[s.audience],o=Array.isArray(e.aud)?e.aud:[e.aud];if(!o.some(function(r){return t.some(function(e){return e instanceof RegExp?e.test(r):e===r})}))return a(new JsonWebTokenError("jwt audience invalid. expected: "+t.join(" or ")))}if(s.issuer&&("string"==typeof s.issuer&&e.iss!==s.issuer||Array.isArray(s.issuer)&&-1===s.issuer.indexOf(e.iss)))return a(new JsonWebTokenError("jwt issuer invalid. expected: "+s.issuer));if(s.subject&&e.sub!==s.subject)return a(new JsonWebTokenError("jwt subject invalid. expected: "+s.subject));if(s.jwtid&&e.jti!==s.jwtid)return a(new JsonWebTokenError("jwt jwtid invalid. expected: "+s.jwtid));if(s.nonce&&e.nonce!==s.nonce)return a(new JsonWebTokenError("jwt nonce invalid. expected: "+s.nonce));if(s.maxAge){if("number"!=typeof e.iat)return a(new JsonWebTokenError("iat required when maxAge is specified"));var r=timespan(s.maxAge,e.iat);if(void 0===r)return a(new JsonWebTokenError('"maxAge" should be a number of seconds or string representing a timespan eg: "1d", "20h", 60'));if(c>=r+(s.clockTolerance||0))return a(new TokenExpiredError("maxAge exceeded",new Date(1e3*r)))}return!0===s.complete?(r=l.signature,a(null,{header:f,payload:e,signature:r})):a(null,e)})};